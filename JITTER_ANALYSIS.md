# Анализ дёргания (jitter) страниц

## Проверенные страницы
- **Главная PL**: `index.html` (index.css, vanilla-app.js, form.js, modal.js)
- **Главная RU**: `ru/index.html` (index.min.css, ru/optimized-styles.css, vanilla-app.js, **ru/init.js**)
- **Химчистка PL**: `pranie.html` (css/styles.css, **js/script.js** — видео, частицы, модалка)
- **Химчистка RU**: `ru/pranie.html` (ru/css/styles.css + inline, **ru/js/script.js** — видео, частицы)

---

## 1. JavaScript — причины дёргания

### 1.1 Обработчик scroll без троттлинга (критично для главной RU)
**Файл:** `ru/init.js`  
**Код:** `window.addEventListener('scroll', scr, {passive:true})` где `scr = () => window.scrollY > 50 ? hdr.classList.add('scrolled') : hdr.classList.remove('scrolled')`.

**Проблема:** На каждый событие `scroll` (при быстром скролле — десятки–сотни раз в секунду) вызывается `classList.add`/`remove`. Это приводит к постоянным перерасчётам стилей и, при наличии `transition` у `.header`, к дёрганию.

**Рекомендация:** Вызывать обработчик не чаще одного раза за кадр (requestAnimationFrame) или раз в 100–150 ms.

### 1.2 Троттлинг в ru/js/script.js и js/script.js
**Реализация:** `Utils.throttle(fn, 16)` откладывает выполнение на 16 ms после **последнего** вызова (по сути debounce), а не «не чаще раза в 16 ms». Во время активного скролла обработчик может не вызываться, а сработать после остановки — для скролла это снижает нагрузку, но поведение не «классический throttle».

**Рекомендация:** Оставить как есть для pranie (скролл там троттлится/дебаунсится); для единообразия и предсказуемости можно заменить на throttle по requestAnimationFrame.

### 1.3 Resize и пересоздание частиц (химчистка PL/RU)
**Файлы:** `ru/js/script.js`, `js/script.js`  
**Код:** `window.addEventListener('resize', handleResize)` с debounce 250 ms; в обработчике `ParticleSystem.destroy()` и `ParticleSystem.createParticles()` — удаление и создание 30 DOM-узлов.

**Проблема:** На мобильных при показе/скрытии панели браузера (адресная строка) часто срабатывает `resize`. Массовое удаление/добавление узлов и пересчёт стилей даёт заметный подлагивание.

**Рекомендация:** На экранах < 768px не пересоздавать частицы при resize (или сильно уменьшить количество частиц на мобильных).

### 1.4 Количество частиц на мобильных
**Константа:** `PARTICLES_COUNT: 30`, одна и та же для всех устройств.  
30 анимированных элементов (transform + opacity + box-shadow) на слабых устройствах могут давать просадки FPS и ощущение дёргания.

**Рекомендация:** На viewport width < 768px использовать меньше частиц (например, 8–10) или отключать анимацию частиц.

### 1.5 body.style.overflow при открытии меню
**Файлы:** `ru/init.js`, мобильное меню на pranie (ru/js/script.js, js/script.js).  
При открытии меню выставляется `document.body.style.overflow = 'hidden'`, при закрытии — `'auto'`.

**Проблема:** Появление/исчезновение скроллбара сдвигает контент по горизонтали и может давать ощущение «дёргания» при открытии/закрытии меню.

**Рекомендация:** Компенсировать ширину скроллбара (например, `padding-right: var(--scrollbar-width)`) при блокировке скролла или оставить как есть, если визуально приемлемо.

---

## 2. CSS и вёрстка — причины дёргания

### 2.1 Загрузка основных стилей (главная PL)
**Файл:** `index.html`  
**Код:** `<link rel="stylesheet" href="/index.css?ver6" media="print" onload="this.media='all'">`.

**Проблема:** До применения основного CSS страница рисуется с «минимальными» стилями, затем при смене `media` на `all` применяется полный layout. Получается один заметный скачок (FOUC / layout shift) — пользователь может воспринять это как «дёргание».

**Рекомендация:** Подключать основной CSS без трюка с `media="print"` (обычный `<link rel="stylesheet" href="...">`), чтобы первый кадр был уже в нужном layout.

### 2.2 backdrop-filter (химчистка и не только)
**Где:** В pranie (PL/RU) — `.video-overlay`, `.header`, `.mobile-menu`, `.stat-card`, `.review-card`, `.modal`, `.modal-content`. В ru/css/styles.css — карточки, модалки.

**Проблема:** `backdrop-filter: blur(...)` заставляет браузер каждый кадр перерисовывать размытие под элементом. На мобильных это одна из самых тяжёлых операций и часто даёт дёргание при скролле или анимациях.

**Рекомендация:** На экранах (max-width: 768px) заменить blur на полупрозрачный фон без backdrop-filter или уменьшить количество таких блоков.

### 2.3 Видеофон (химчистка PL/RU)
**Классы:** `.video-background`, `.video-background video` (position: fixed, на весь экран, autoplay muted loop).

**Проблема:** Декодирование и отрисовка видео на мобильных потребляют CPU/GPU; в сочетании с overlay и частицами возможны просадки FPS и «дёргание» при скролле.

**Рекомендация:** На мобильных можно не воспроизводить видео, а показывать только poster; или уменьшить разрешение/битрейт для мобильной версии.

### 2.4 Непрерывные анимации
**Где:**  
- `.hero::before` — `animation: pulse 4s ease-in-out infinite` (pranie PL/RU).  
- `.particle` — `animation: float 25s infinite linear` (много элементов).

**Проблема:** Постоянные анимации (особенно с transform + opacity и с большим количеством элементов) увеличивают нагрузку. В комбинации с видео и backdrop-filter усиливают дёргание.

**Рекомендация:** На мобильных отключить pulse у hero или упростить; уменьшить число частиц (см. п. 1.4).

### 2.5 transition: all у .header
**Стили pranie (inline в ru/pranie.html и в pranie.html):** `.header { transition: all var(--transition-normal) }`.

**Проблема:** При добавлении/удалении класса `.scrolled` пересчитываются все свойства. Умеренный вклад в дёргание при частом срабатывании скролла.

**Рекомендация:** Ограничить: `transition: background-color 0.3s, box-shadow 0.3s` (или только нужные свойства).

### 2.6 scroll-behavior: smooth
**Где:** В pranie (PL/RU) в корне: `html { scroll-behavior: smooth }`.

**Проблема:** На части устройств/браузеров плавный скролл может подлагивать. Обычно не главная причина, но может усиливать ощущение дёргания при навигации по якорям.

**Рекомендация:** При сохранении проблем на мобильных — отключить `scroll-behavior: smooth` в медиазапросе для узких экранов.

---

## 3. Сводка по страницам

| Страница        | Наиболее вероятные причины дёргания |
|-----------------|-------------------------------------|
| Главная PL      | FOUC из-за загрузки index.css через media="print" → один резкий сдвиг. |
| Главная RU      | **Scroll без троттлинга в ru/init.js** → частые classList и transition у header. |
| Химчистка PL/RU | Комбинация: **видео** + **30 частиц** (в т.ч. box-shadow) + **backdrop-filter** на многих блоках + **resize** с пересозданием частиц + непрерывная анимация pulse. |

---

## 4. Внесённые исправления (в коде)

1. **ru/init.js** — добавлен троттлинг скролла через requestAnimationFrame (один вызов за кадр).
2. **ru/js/script.js** и **js/script.js** — на viewport < 768px уменьшено количество частиц (10 вместо 30); при resize на мобильных частицы не пересоздаются.
3. **index.html** — основной CSS подключается без media="print" (устранение FOUC на главной PL).
4. Стили pranie (inline в ru/pranie.html и в pranie.html) — у `.header` переход ограничен свойствами `background-color` и `box-shadow` вместо `all`.

Дополнительно при необходимости: отключение/упрощение видео на мобильных, замена backdrop-filter на сплошной фон в медиазапросе, отключение или упрощение анимации pulse на мобильных.
