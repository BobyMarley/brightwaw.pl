# 💬 Система мессенджера

## Что реализовано:

### ✅ Функции:
1. **Личные чаты** - админ может писать каждому работнику отдельно
2. **Общий рабочий чат** - все работники + админ в одном чате
3. **История сообщений** - все сообщения сохраняются в Firestore
4. **Загрузка фото** - можно отправлять изображения (до 5MB)
5. **Эмодзи** - быстрый доступ к популярным эмодзи
6. **Обновление в реальном времени** - сообщения появляются мгновенно
7. **Адаптивный дизайн** - работает на мобильных и десктопе

### 📁 Структура базы данных:

```
chats/
  {chatId}/
    participants: [userId1, userId2, ...]
    participantNames: { userId1: "Name1", userId2: "Name2" }
    type: "direct" | "group"
    name: "Общий чат" (для группового)
    lastMessage: "Текст последнего сообщения"
    lastMessageTime: timestamp
    
    messages/
      {messageId}/
        senderId: "userId"
        senderName: "User Name"
        text: "Текст сообщения"
        imageUrl: "https://..." (опционально)
        createdAt: timestamp
```

### 🎨 Интерфейс:

```
┌─────────────────────────────────────────────┐
│  💬 Мессенджер                              │
├──────────────┬──────────────────────────────┤
│ Сообщения    │  Общий чат                   │
│              │  ┌────────────────────────┐  │
│ 👥 Общий чат │  │ Админ: Привет всем!   │  │
│              │  └────────────────────────┘  │
│ 👤 Анна      │  ┌────────────────────────┐  │
│ 👤 Иван      │  │ Вы: Добрый день!      │  │
│ 👤 Мария     │  └────────────────────────┘  │
│              │                              │
│              │  [Написать сообщение...] 😊📷➤│
└──────────────┴──────────────────────────────┘
```

## Для админа:

### Возможности:
- ✅ Создать общий чат со всеми работниками
- ✅ Писать каждому работнику отдельно
- ✅ Видеть список всех работников в сайдбаре
- ✅ Отправлять фото и эмодзи
- ✅ Видеть историю всех сообщений

### Как использовать:
1. Откройте "Сообщения" в меню
2. Нажмите "Общий чат" для группового чата
3. Или выберите работника для личного чата
4. Пишите сообщения, отправляйте фото
5. Используйте эмодзи через кнопку 😊

## Для работника:

### Возможности:
- ✅ Писать админу
- ✅ Участвовать в общем чате
- ✅ Отправлять фото и эмодзи
- ✅ Видеть историю сообщений

### Как использовать:
1. Откройте "Сообщения" в меню
2. Выберите "Общий чат" или чат с админом
3. Пишите сообщения
4. Отправляйте фото через кнопку 📷
5. Используйте эмодзи через кнопку 😊

## Технические детали:

### Firestore Rules:
```javascript
match /chats/{chatId} {
  allow read: if request.auth.uid in resource.data.participants;
  allow create: if request.auth != null;
  allow update: if request.auth.uid in resource.data.participants;
}

match /chats/{chatId}/messages/{messageId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null;
  allow update: if request.auth.uid == resource.data.senderId;
  allow delete: if isAdmin();
}
```

### Storage Rules:
```javascript
match /chat-images/{imageId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null && 
                  request.resource.size < 5 * 1024 * 1024 && // 5MB
                  request.resource.contentType.matches('image/.*');
}
```

### Компоненты:
- `ChatMessenger.tsx` - основной компонент мессенджера
- `Chat.tsx` - страница чата
- Интеграция в `Layout.tsx` и `App.tsx`

## Безопасность:

### ✅ Защита:
- Только участники чата могут читать сообщения
- Только авторизованные пользователи могут писать
- Только автор может редактировать свое сообщение
- Только админ может удалять сообщения
- Ограничение размера фото: 5MB
- Только изображения (image/*)

### 🔒 Приватность:
- Личные чаты видны только участникам
- Общий чат видят все работники + админ
- История сообщений сохраняется

## Возможные улучшения:

- [ ] Уведомления о новых сообщениях (push notifications)
- [ ] Счетчик непрочитанных сообщений
- [ ] Статус "печатает..."
- [ ] Статус "прочитано"
- [ ] Поиск по сообщениям
- [ ] Удаление сообщений
- [ ] Редактирование сообщений
- [ ] Ответ на сообщение (reply)
- [ ] Пересылка сообщений
- [ ] Голосовые сообщения
- [ ] Видео звонки
- [ ] Файлы (PDF, документы)
- [ ] Стикеры и GIF

## Настройка:

### 1. Firestore Rules:
Скопируйте правила из `firestore-rules-fixed.rules` в Firebase Console

### 2. Storage Rules:
Скопируйте правила из `storage.rules` в Firebase Console → Storage → Rules

### 3. Готово!
Мессенджер готов к использованию 🎉

## Использование:

### Админ:
```
Меню → Сообщения → Выбрать работника или Общий чат
```

### Работник:
```
Меню → Сообщения → Общий чат или чат с админом
```

## Поддержка:

Мессенджер работает на:
- ✅ Desktop (Chrome, Firefox, Safari, Edge)
- ✅ Mobile (iOS Safari, Android Chrome)
- ✅ Tablet

Требования:
- ✅ Авторизация в системе
- ✅ Интернет соединение
- ✅ Современный браузер

---

**Статус:** ✅ Готово к использованию
**Дата:** 2024
